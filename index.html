<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User/Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5;}
.container { max-width: 900px; margin: 50px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
input, button { padding: 10px; margin:5px 0; width: 100%; border-radius:5px; border:1px solid #ccc;}
button { cursor:pointer; background:#007BFF; color:#fff; border:none;}
button:hover { background:#0056b3;}
.tab { display:none; }
.tab.active { display:block; }
.nav { display:flex; gap:10px; margin-bottom:20px; }
.nav button { flex:1; }
table { width:100%; border-collapse: collapse; margin-top:10px;}
table, th, td { border:1px solid #ccc;}
th, td { padding:10px; text-align:left;}
img { max-width:100px; max-height:80px;}
</style>
</head>
<body>

<div class="container">
    <h2 id="welcomeText">Login/Register</h2>
    
    <div id="loginForm">
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="showRegister()">Register</button>
    </div>

    <div id="registerForm" style="display:none;">
        <input type="text" id="regUsername" placeholder="New Username">
        <input type="password" id="regPassword" placeholder="New Password">
        <button onclick="register()">Register</button>
        <button onclick="showLogin()">Back to Login</button>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="nav">
            <button onclick="showTab('walletTab')">Wallet</button>
            <button onclick="showTab('combatTab')">Combat</button>
            <button id="adminTabBtn" onclick="showTab('adminTab')" style="display:none;">Admin</button>
        </div>

        <!-- Wallet Tab -->
        <div id="walletTab" class="tab">
            <h3>Wallet Management</h3>
            <input type="text" id="walletName" placeholder="Name">
            <input type="text" id="walletAddress" placeholder="Wallet Address">
            <button onclick="addWallet()">Add Wallet</button>
            <table id="walletTable">
                <thead><tr><th>Name</th><th>Wallet</th><th>Added By</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Combat Tab -->
        <div id="combatTab" class="tab">
            <h3>Combat Update</h3>
            <input type="text" id="combatName" placeholder="Name">
            <input type="file" id="combatImage">
            <button onclick="addCombat()">Add Combat</button>
            <table id="combatTable">
                <thead><tr><th>Name</th><th>Image</th><th>Combat Power</th><th>Added By</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab">
            <h3>Admin Panel</h3>
            <button onclick="downloadWallet()">Download Wallet as Excel</button>
            <p>Admin can edit/delete tables above and allow users to update without removing old entries.</p>
        </div>
    </div>
</div>

<script>
// --- Storage ---
let users = JSON.parse(localStorage.getItem('users')) || [{username:'admin', password:'0101', role:'admin', canEdit:false}];
let walletData = JSON.parse(localStorage.getItem('walletData')) || [];
let combatData = JSON.parse(localStorage.getItem('combatData')) || [];
let currentUser = null;

// --- Login/Register ---
function showRegister(){ document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='block'; }
function showLogin(){ document.getElementById('loginForm').style.display='block'; document.getElementById('registerForm').style.display='none'; }
function login(){
    let user = document.getElementById('username').value;
    let pass = document.getElementById('password').value;
    let found = users.find(u=>u.username===user && u.password===pass);
    if(found){ 
        currentUser = found; 
        document.getElementById('loginForm').style.display='none';
        document.getElementById('registerForm').style.display='none';
        document.getElementById('dashboard').style.display='block';
        document.getElementById('welcomeText').innerText = `Welcome ${currentUser.username}`;
        if(currentUser.role==='admin'){ document.getElementById('adminTabBtn').style.display='block'; }
        renderWalletTable(); renderCombatTable(); showTab('walletTab');
    } else { alert('Invalid credentials'); }
}
function register(){
    let user = document.getElementById('regUsername').value;
    let pass = document.getElementById('regPassword').value;
    if(users.find(u=>u.username===user)){ alert('Username exists'); return; }
    users.push({username:user,password:pass,role:'user', canEdit:false});
    localStorage.setItem('users',JSON.stringify(users));
    alert('Registered successfully!');
    showLogin();
}

// --- Tabs ---
function showTab(tabId){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
}

// --- Wallet Management ---
function addWallet(){
    let name = document.getElementById('walletName').value;
    let wallet = document.getElementById('walletAddress').value;
    if(!name || !wallet) return alert('Fill all fields');
    walletData.push({name, wallet, addedBy:currentUser.username});
    localStorage.setItem('walletData', JSON.stringify(walletData));
    renderWalletTable();
}
function renderWalletTable(){
    let tbody = document.querySelector('#walletTable tbody');
    tbody.innerHTML='';
    walletData.forEach((w,i)=>{
        let actions = (currentUser.role==='admin') ? `<button onclick="editWallet(${i})">Edit</button> <button onclick="deleteWallet(${i})">Delete</button>` : '';
        tbody.innerHTML += `<tr><td>${w.name}</td><td>${w.wallet}</td><td>${w.addedBy}</td><td>${actions}</td></tr>`;
    });
}
function editWallet(index){
    let newName = prompt('Edit Name', walletData[index].name);
    let newWallet = prompt('Edit Wallet', walletData[index].wallet);
    if(newName && newWallet){
        walletData[index].name = newName;
        walletData[index].wallet = newWallet;
        localStorage.setItem('walletData', JSON.stringify(walletData));
        renderWalletTable();
    }
}
function deleteWallet(index){
    if(confirm('Delete this wallet?')){
        walletData.splice(index,1);
        localStorage.setItem('walletData', JSON.stringify(walletData));
        renderWalletTable();
    }
}
function downloadWallet(){
    let csv = 'Name,Wallet,AddedBy\n'+walletData.map(w=>`${w.name},${w.wallet},${w.addedBy}`).join('\n');
    let blob = new Blob([csv], {type:'text/csv'});
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a'); a.href=url; a.download='wallet.csv'; a.click();
}

// --- Combat Management ---
function addCombat(){
    let name = document.getElementById('combatName').value;
    let imgFile = document.getElementById('combatImage').files[0];
    if(!name || !imgFile) return alert('Fill all fields');
    
    let reader = new FileReader();
    reader.onload = function(e){
        let imgData = e.target.result;

        // Use Tesseract.js to detect text
        Tesseract.recognize(imgData, 'eng', {logger: m => console.log(m)})
        .then(({ data: { text } }) => {
            // Extract combat power number from OCR text
            // Look for pattern "Combat Power XX,XXX"
            let match = text.match(/Combat\s*Power\s*([\d,]+)/i);
            let detectedPower = match ? match[1].replace(/,/g,'') : 0;

            combatData.push({
                name,
                image: imgData,
                power: detectedPower,
                addedBy: currentUser.username
            });

            localStorage.setItem('combatData', JSON.stringify(combatData));
            renderCombatTable();
            alert(`Detected Combat Power: ${detectedPower}`);
        })
        .catch(err => { console.error(err); alert('Failed to detect combat power'); });
    }
    reader.readAsDataURL(imgFile);
}

function renderCombatTable(){
    let tbody = document.querySelector('#combatTable tbody');
    tbody.innerHTML='';
    combatData.forEach((c,i)=>{
        let actions = (currentUser.role==='admin') ? `<button onclick="editCombat(${i})">Edit</button> <button onclick="deleteCombat(${i})">Delete</button>` : '';
        tbody.innerHTML += `<tr><td>${c.name}</td><td><img src="${c.image}"></td><td>${c.power}</td><td>${c.addedBy}</td><td>${actions}</td></tr>`;
    });
}
function editCombat(index){
    let newName = prompt('Edit Name', combatData[index].name);
    let newPower = prompt('Edit Combat Power', combatData[index].power);
    if(newName && newPower){
        combatData[index].name = newName;
        combatData[index].power = newPower;
        localStorage.setItem('combatData', JSON.stringify(combatData));
        renderCombatTable();
    }
}
function deleteCombat(index){
    if(confirm('Delete this combat entry?')){
        combatData.splice(index,1);
        localStorage.setItem('combatData', JSON.stringify(combatData));
        renderCombatTable();
    }
}
</script>

</body>
</html>
